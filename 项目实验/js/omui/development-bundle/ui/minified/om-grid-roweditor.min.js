(function(d){var l=Object.prototype.hasOwnProperty;d.omWidget.addInitListener("om.omGrid",function(){var A=this,z=A.element,C=A.options,x=this._getColModel();A._triggered=false;A._globalEditable=false;C.editMode=C.editMode||"all";A._allEditMode=C.editMode=="all";for(var B=0,w=x.length;B<w;B++){A._globalEditable=x[B]["editor"]?true:false;if(A._globalEditable){break}}if(!i(A)){return}A._editComps={};A._errorHolders={};A._colWidthResize;C._onRefreshCallbacks.push(t);C._onResizableCallbacks.push(k);C._onResizeCallbacks.push(j);this.tbody.delegate("tr.om-grid-row","dblclick",function(D){b.call(this,A)});this.tbody.delegate("tr.om-grid-row","click",function(D){if(A._triggered&&A._editView.editing){if(A._validator){A._validator.valid()&&b.call(this,A)}else{b.call(this,A)}}});var y;z.parent().scroll(function(){if(A._triggered){if(y){clearTimeout(y)}y=setTimeout(function(){var D=v(A);A._editView.editBtn.animate({left:D.left,top:D.top},A._editView.editing?"fast":0);y=null},300)}});d.extend(this,{cancelEdit:function(F){var E=this._editView,D=this.options;if(!i(this)||!this._triggered||(this._triggered&&!E.editing)){return}E.view.hide();E.editing=false;if(this._rowAdding){this.deleteRow(this._getTrs().index(this.tbody.find("tr[_grid_row_id='"+A._editView.rowId+"']")));this._rowAdding=false}s(this);F&&d(F).blur();D.onCancelEdit&&D.onCancelEdit.call(this)},cancelChanges:function(){this.cancelEdit();if(f(this)){return}g(this);s(this);this.refresh()},editRow:function(D){if(!i(this)){return}b.call(this._getTrs().eq(D)[0],this)},deleteRow:function(F){if(!i(this)||(this._triggered&&this._editView.editing)){return}var E=this._getTrs(),D=this;if(!d.isArray(F)){F=[F]}F.sort(function(H,G){return G-H});d(F).each(function(H,J){var I=E.eq(J),G=I.next(),K=a(I);if(I.attr("_insert")){delete D._changeData.insert[K];I.remove();if(G.hasClass("rowExpand-rowDetails")){G.remove()}}else{D._changeData["delete"][K]=D._rowIdDataMap[K];I.attr("_delete","true").hide();if(G.hasClass("rowExpand-rowDetails")){G.hide()}}});this._refreshHeaderCheckBox()},getChanges:function(H){var J={update:[],insert:[],"delete":[]},D=H?H:"update",G=this._changeData,F;if(D==="update"){var E=G[D];for(F in E){l.call(E,F)&&J[D].push(d.extend(true,{},this._rowIdDataMap[F],E[F]))}D=H?H:"insert"}if(D==="insert"){var I=G[D];for(F in I){l.call(I,F)&&J[D].push(I[F])}D=H?H:"delete"}if(D==="delete"){var K=G[D];for(F in K){l.call(K,F)&&J[D].push(K[F])}}if(H){return J[H]}else{return J}},insertRow:function(O,I,R){var F=this.options,P=this._getColModel(),E=this.element;if(!i(this)||this._rowAdding){return}if(d.isPlainObject(O)){I=O;O=0}if(O===true){I={};O=0;R=true}var G=this._getTrs(),S={};O=("begin"==O||O==undefined)?0:("end"==O?G.length:O);for(var K=0,N=P.length;K<N;K++){S[P[K]["name"]]=""}this._changeData.insert[this._guid]=d.extend(true,S,I);var Q=this._buildRowCellValues(P,S,O),D=[],H=F.rowClasses;isRowClassesFn=(typeof H==="function"),rowCls=isRowClassesFn?H(O,S):H[O%H.length],tdTmp="<td align='$' abbr='$' class='grid-cell-dirty $'><div align='$' class='$' style='width:$px'>$</div></td>";D.push("<tr class='om-grid-row "+rowCls+"' _grid_row_id="+(this._guid++)+" _insert='true'>");this._getHeaderCols().each(function(W){var Y=d(this).attr("axis"),X=false,V,Z,U;if(Y=="indexCol"){V="<a class='om-icon'>新行</a>"}else{if(Y=="checkboxCol"){V='<span class="checkbox"/>'}else{if(Y.substring(0,3)=="col"){var T=Y.substring(3);V=Q[T];if(P[T].wrap){X=true}}else{V=""}}}Z=[this.align,this.abbr,Y,this.align,X?"wrap":"",d("div",d(this)).width(),V];U=0;D.push(tdTmp.replace(/\$/g,function(){return Z[U++]}))});D.push("</tr>");var M=d(D.join(" ")),L,J;if(O==0){M.prependTo(E.find(">tbody"))}else{L=G.eq(O-1);J=L.next();L=J.hasClass("rowExpand-rowDetails")?J:L;L.after(M)}if(!R){this.editRow(O);this._rowAdding=true}},saveChanges:function(){this.cancelEdit();if(f(this)){return}var F=this._changeData.update,E=this.element.find("tr.om-grid-row"),H=[];for(var G in F){if(l.call(F,G)){d.extend(true,this._rowIdDataMap[G],F[G])}}var D=this;E.each(function(I,K){var J=d(K);if(J.attr("_delete")){J.remove()}else{H.push(u(D,K))}});this.pageData.data.rows=H;g(this);s(this);this.refresh()},onBeforeEdit:function(E,D){},onAfterEdit:function(E,D){},onCancelEdit:function(){},getData:function(){var D=this.pageData.data,F=this._getTrs(),E=this;if(i(this)&&h(this)){D={total:D.total};D.rows=[];F.each(function(G,H){D.rows.push(E._getRowData(G))})}return D},_getRowData:function(E){var G=this._getTrs().eq(E),I=a(G),H;if(f(this)){return this.pageData.data.rows[E]}if(G.attr("_insert")){H=this._changeData.insert[I]}else{var F=this._rowIdDataMap[I],D=this._changeData.update;H=F;if(D[I]){H=d.extend(true,{},F,D[I])}}return H}})});function b(H){var C=d(this),x=H.element,D,B,A,G=H._getColModel(),w,F,y=H.options;if(!i(H)){return}if(!H._allEditMode&&!C.attr("_insert")){return}if(H._triggered&&H._editView.editing&&a(C)==H._editView.rowId){return}if(H._rowAdding){return}var E=H._getTrs().index(C),z=H._getRowData(E);if(y.onBeforeEdit&&y.onBeforeEdit.call(H,E,z)===false){return}q(H,C);D=H._editView.editRow;B=D.find(">.grid-edit-form");A=x.parent().scrollLeft();H._getHeaderCols().each(function(Q){var L=d(this).attr("axis"),N,T=C.find("td:eq("+Q+")"),I,V;if(L.substring(0,3)=="col"){var U=L.substring(3);N=G[U]}else{if(d.isEmptyObject(H._editComps)){D.css("padding-left",parseInt(D.css("padding-left"))+T.outerWidth())}return}var P=N.editor;if(!H._triggered){if(!P||(P&&(P.editable===false||(d.isFunction(P.editable)&&P.editable()===false)))){var R=P&&P.renderer;N.editor=P={};P.type="text";if(R){P.renderer=R;P.type="custom"}P.editable=false}else{P.type=P.type||"text";P.editable=true;if(P.rules){H._validate=true}}V=N.editor.name||N.name;P.options=P.options||{};H._editComps[V]={}}else{V=N.editor.name||N.name}w=H._editComps[V];F=(F=n(H,C,N))==undefined?"":F;if(!H._triggered&&P.editable&&P.rules){H._errorHolders[V]=d("<div class='errorContainer' style='display:none'></div>").appendTo(x.parent())}var K=w.instance,O,S=P.type;if(!K){O=d("<div style='position:absolute'></div>").css({left:T.position().left+A,top:3}).appendTo(B).addClass("grid-edit-wrapper");K=w.instance=d("<input></input>").attr({name:V,id:V}).appendTo(O);if("text"!=S&&"custom"!=S){K[S](P.options)}if("omCalendar"==S||"omCombo"==S){var M=K.parent();if("omCalendar"==S){K.val(F).width(T.outerWidth()-24);K.width(T.outerWidth(true)-(M.outerWidth(true)-K.width()))}else{K.next("input").attr({id:K.prop("id"),name:K.prop("name")});K.attr({id:"",name:""});K.next("input").width(T.outerWidth(true)-(M.outerWidth(true)-K.next("input").width()))}}else{if("text"==S){K.addClass("grid-edit-text");if(!P.editable){K.attr("readonly","readonly").addClass("readonly-text")}}if("custom"==S){K=w.instance=O.html(P.renderer.call(H,F,z))}K.width(T.outerWidth(true)-(K.outerWidth(true)-K.width()))}w.model=N;w.type=S;w.id=N.name;if("custom"!=S){var J="omCombo"==S?K.next():K;J.blur(function(X){var W=H._errorHolders[V];W&&W.hide()})}}switch(S){case"omCalendar":K=K.val(F).omCalendar();break;case"omNumberField":K.val(F).trigger("blur");break;case"omCombo":K.omCombo("value",F);break;case"text":K.val(F);break;case"custom":K.html(P.renderer.call(H,F,z));default:}});!H._triggered&&H._validate&&p(H);H._validator&&H._validator.form();H._triggered=true}function g(w){w._changeData={update:{},insert:{},"delete":{}}}function f(w){return !i(w)||!h(w)}function v(x){var w=x.element,z=w.parent(),A=x._editView,B=A.view,y=A.editBtn,D=A.editRow,C={};C.top=D.height();if(w.width()<z.width()){C.left=w.width()/2-y.width()/2}else{C.left=z.scrollLeft()+z.width()/2-y.width()/2}return C}function t(){if(i(this)){g(this);r(this);if(this._triggered){s(this);this._editView.view.hide();this._editView.editing=false;this.hDiv.scrollLeft(0);this.element.parent().scrollLeft(0)}}}function i(w){return !w._allEditMode||w._globalEditable}function r(x){var w=x.getData().rows;x._rowIdDataMap={};x._getTrs().each(function(y,z){x._rowIdDataMap[a(z)]=w[y]})}function s(w){if(w._validator){w._validator.resetForm();d.each(w._errorHolders,function(x,y){y.empty().hide()})}}function h(x){var w=x._changeData;return !(d.isEmptyObject(w.update)&&d.isEmptyObject(w.insert)&&d.isEmptyObject(w["delete"]))}function q(H,D){var w=H.element,G=w.next(".grid-edit-view"),F,C,A=d(D).position(),y=w.parent().scrollTop(),x=H.options;if(G.length==0){G=d("<div class='grid-edit-view'><div class='body-wrapper'><div class='grid-edit-row'><form class='grid-edit-form'></form></div><div class='gird-edit-btn'><input type='button' class='ok' value='确定'/><input type='button' class='cancel' value='取消'/></div></div></div>").width(w.outerWidth()).insertAfter(w);var F=G.find(".gird-edit-btn"),C=F.prev(".grid-edit-row"),E;H._editView={view:G,editRow:C,editBtn:F};E=v(H);F.css({left:E.left,top:E.top});var B=F.find("input.ok").omButton(),z=F.find("input.cancel").omButton();B.click(function(){if(H._validator&&!H._validator.form()){return}var I=w.find("tr[_grid_row_id='"+H._editView.rowId+"']");c(H,I);G.hide();H._editView.editing=false;B.blur();if(H._rowAdding){H._refreshHeaderCheckBox();H._rowAdding=false}var J=H._getTrs().index(I);x.onAfterEdit&&x.onAfterEdit.call(H,J,H._getRowData(J))});z.click(function(){H.cancelEdit(this)})}H._editView.rowId=a(D);if(H._editView.editing){G.animate({top:A.top+y},"fast")}else{G.css({top:A.top+y});H._editView.editing=true;G.show();if(H._colWidthResize){o(H);H._colWidthResize=false}}}function j(){if(!i(this)||!this._triggered){return}if(this._editView.editing){this.element.parent().scrollLeft(0);var w=this;setTimeout(function(){o(w)},0)}else{this._colWidthResize=true}}function o(F,C,y){var w=F.element,B=F._editView,E=B.view,x=w.parent().scrollLeft(),D=B.editBtn,z;E.width(w.outerWidth());F._getHeaderCols().each(function(G,I){var K=d(I).attr("abbr"),H=d(I),J=C&&C.prop("abbr")===H.prop("abbr");if(J){z=true}if(C&&!z){return}d.each(F._editComps,function(M,L){var O=L.instance,N=L.type;if(K==L.id){if(!J&&C){O.closest("div.grid-edit-wrapper").css("left","+="+y);return false}if(!J){O.closest("div.grid-edit-wrapper").width(H.outerWidth()).css("left",H.position().left+x)}if("omCalendar"==N||"omCombo"==N){var P=O.parent();if("omCalendar"==N){O.width(H.outerWidth()-24);O.width(H.outerWidth(true)-(P.outerWidth(true)-O.width()))}else{O.next("input").width(H.outerWidth(true)-(P.outerWidth(true)-O.next("input").width()))}}else{O.width(H.outerWidth(true)-(O.outerWidth(true)-O.width()))}}})});var A=v(F);if(C){D.animate({left:A.left,top:A.top},"fast")}else{D.css({left:A.left,top:A.top})}}function k(w,x){if(!i(this)||!this._triggered||!this._editView.editing){this._colWidthResize=true;return}o(this,w,x)}function c(w,A){var y=d(A),D=w._editView.editRow,C=w._editComps,B=a(y),x=w._getTrs().index(y),z=w._getRowData(x);d.each(C,function(G,F){var I=F.model.name,K=e(w,y,F),E,H,J;if(y.attr("_insert")){w._changeData.insert[B][I]=K}else{E=u(w,A)[I];J=w._changeData.update[B];if(String(K)===String(E)){m(y,F.model,false);J&&delete J[I];d.isEmptyObject(J)&&delete w._changeData.update[B]}else{m(y,F.model,true);J=w._changeData.update[B]=J||{};J[I]=K}}if(F.model.renderer){H=F.model.renderer(K,z,x)}else{H=K==undefined?"":K}y.find("td[abbr='"+I+"'] >div").html(H)})}function m(y,x,w){y.find("td[abbr='"+x.name+"']").toggleClass("grid-cell-dirty",w)}function a(w){return d(w).attr("_grid_row_id")}function e(x,z,w){var B,A=u(x,z),y=w.instance;switch(w.type){case"omCalendar":B=y.val();case"omNumberField":B=y.val();break;case"omCombo":B=y.omCombo("value");break;case"text":B=y.val();break;case"custom":if(w.model.editor.getValue){return w.model.editor.getValue.call(y,A,w.model.name)}default:break}return B}function n(w,A,z){var B,y=z.name;if(A.attr("_insert")){B=u(w,A)[y]}else{var x=w._changeData.update[a(A)];if(x&&x[y]!=null){B=x[y]}else{B=u(w,A)[y]}}return B}function u(w,x){var y=a(x);return d(x).attr("_insert")?w._changeData.insert[y]:w._rowIdDataMap[y]}function p(x){var w=x._editView.editRow.find(">.grid-edit-form"),A={},B=A.rules={},z=A.messages={},y=x._getColModel();d.each(y,function(I,G){var H=G.editor.rules;if(H){var C=B[G.editor.name||G.name]={},E=z[G.editor.name||G.name]={};if(H.length>0&&!d.isArray(H[0])){var K=[];K.push(H);H=K}for(var F=0,J=H.length;F<J;F++){var D=H[F][0];C[D]=H[F][1]==undefined?true:H[F][1];if(H[F][2]){E[D]=H[F][2]}}}});d.extend(A,{onkeyup:function(C){this.element(C)},errorPlacement:function(C,D){},showErrors:function(E,F){if(F&&F.length>0){d.each(F,function(K,M){var I=d(M.element),J=I.attr("name");var L=x._errorHolders[J];if(L){var H=I.offset(),G=x.element.offset();L.css({left:H.left-G.left+I.outerWidth(),top:H.top-G.top+I.outerHeight()}).html(M.message);if(I.is(":focus")){L.show()}}})}else{d.each(this.currentElements,function(G,H){var I=x._errorHolders[d(H).attr("name")];I&&I.empty().hide()})}var C=x._editView.editBtn.find("input.ok"),D=true;d.each(x._errorHolders,function(G,H){if(!H.is(":empty")){return D=false}});D?C.omButton("enable"):C.omButton("disable");this.defaultShowErrors()}});x._validator=w.validate(A);d.each(x._editComps,function(E,D){var G=D.model.editor;if(G.editable&&G.rules){var F=G.name||D.model.name,H=x._errorHolders[F],C=D.type=="omCombo"?D.instance.next("input"):D.instance;C.mouseover(function(){if(H&&!H.is(":empty")){H.show()}}).mouseout(function(){H&&H.hide()})}})}})(jQuery);