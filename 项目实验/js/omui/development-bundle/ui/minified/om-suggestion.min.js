(function(c){var a="om-suggestion-list-row";var b="om-state-hover";c.omWidget("om.omSuggestion",{options:{disabled:false,readOnly:false,minChars:1,delay:500,cacheSize:10,method:"GET",listMaxHeight:300,queryName:"key",crossDomain:false,preProcess:function(e,d){return d},onBeforeSuggest:function(e,d){},onSuggesting:function(e,d){},onSuccess:function(e,f,d){},onError:function(f,g,e,d){},onSelect:function(f,g,d,e){}},_create:function(){this.element.addClass("om-suggestion om-widget om-state-default om-state-nobg");this.dropList=c('<div class="om-widget"><div class="om-widget-content om-droplist"></div></div>').css({position:"absolute",zIndex:2000}).appendTo(document.body).children().first().hide()},_init:function(){var d=this,e=this.options,g=this.element.attr("autocomplete","off"),f=this.dropList;if(e.minChars<0){e.minChars=0}if(e.cacheSize<0){e.cacheSize=0}if(e.delay<0){e.delay=0}e.disabled?this.disable():this.enable();e.readOnly?g.attr("readonly","readonly"):g.removeAttr("readonly");g.focus(function(){c(this).addClass("om-state-focus")}).blur(function(){c(this).removeClass("om-state-focus")}).keydown(function(h){if(h.keyCode==c.om.keyCode.TAB){f.hide()}}).keyup(function(j){var i=j.keyCode,k=c.om.keyCode;switch(i){case k.DOWN:if(f.css("display")!=="none"){d._selectNext()}else{if(f.find("."+a).size()>0){f.show()}}break;case k.UP:if(f.css("display")!=="none"){d._selectPrev()}else{if(f.find("."+a).size()>0){f.show()}}break;case k.ENTER:if(f.css("display")==="none"){return}f.hide();d._triggerOnSelect(j);return false;case k.ESCAPE:f.hide();break;case k.TAB:break;default:if(e.disabled||e.readOnly){return false}if(e.delay>0){var h=c.data(g,"delayTimer");if(h){clearTimeout(h)}h=setTimeout(function(){d._suggest()},e.delay);c.data(g,"delayTimer",h)}else{d._suggest()}}}).mousedown(function(h){h.stopPropagation()});f.mousedown(function(h){h.stopPropagation()});c(document).bind("mousedown.omSuggestion",this.globalEvent=function(){f.hide()})},clearCache:function(){c.removeData(this.element,"cache")},showMessage:function(f){var g=this.element;var e=this.dropList.empty().css("height","auto");c("<div>"+f+"<div>").appendTo(e);e.parent().css("left",g.offset().left).css("top",g.offset().top+g.outerHeight());var h=this.options.listWidth;if(!h){e.parent().width(g.outerWidth())}else{if(h!=="auto"){e.parent().width(h)}}e.show();var d=this.options.listMaxHeight;if(d!=="auto"){if(e.height()>d){e.height(d).css("overflow","auto")}}return this},disable:function(){this.options.disabled=true;return this.element.attr("disabled","disabled").addClass("om-state-disabled")},enable:function(){this.options.disabled=false;return this.element.removeAttr("disabled").removeClass("om-state-disabled")},setData:function(e){var d=this.options;if(e){d.dataSource=e}if(d.cacheSize>0){this.clearCache()}},getData:function(){var d=c.data(this.element,"records");return d||null},getDropList:function(){return this.dropList},destroy:function(){c(document).unbind("mousedown.omSuggestion",this.globalEvent);this.dropList.parent().remove()},_clear:function(){this.element.val("");return this.dropList.find("."+a).removeClass(b)},_selectNext:function(){var e=this.dropList,d=e.find("."+b).index(),f=this._clear();d+=1;if(d>=f.size()){d=0}this._scrollToAndSelect(f,d,e)},_selectPrev:function(){var e=this.dropList,d=e.find("."+b).index(),f=this._clear();d-=1;if(d<0){d=f.size()-1}this._scrollToAndSelect(f,d,e)},_scrollToAndSelect:function(g,d,f){if(g.size()<1){return}var h=c(g.get(d)).addClass(b);var e=h.position().top;if(e<=0){f.scrollTop(f.scrollTop()+e)}else{var i=e+h.outerHeight()-f.height();if(i>0){f.scrollTop(f.scrollTop()+i)}}this._select(d)},_select:function(e){var g=this.element;var d=c.data(g,"records");var f,h;if(d.valueField){f=d.data[e];h=f[d.valueField]}else{f=d[e];h=f}g.val(h);c.data(g,"lastStr",h)},_suggest:function(){var g=this.element;var i=g.val();var h=c.data(g,"lastStr");if(h&&h===i){return}c.data(g,"lastStr",i);var l=this.options;var d=c.data(g,"cache");if(i.length>0&&i.length>=l.minChars){if(d){var e=d[i];if(e){c.data(g,"records",e);this._buildDropList(e,i);return}}if(l.onBeforeSuggest){if(this._trigger("onBeforeSuggest",null,i)===false){this.dropList.empty().hide();return}}var k=this;var j={url:l.dataSource,type:l.method,dataType:l.crossDomain?"jsonp":"json",data:{},success:function(q,s){var r=l.onSuccess;if(r&&k._trigger("onSuccess",null,q,s)===false){return}var o=l.preProcess;if(o){q=o(i,q)}if(typeof q==="undefined"){q=[]}if(l.cacheSize>0){var n=c.data(g,"cache")||{___keys:[]};var p=n.___keys;if(p.length==l.cacheSize){var m=p[0];n.___keys=p.slice(1);n[m]=undefined}n[i]=q;n.___keys.push(i);c.data(g,"cache",n)}c.data(g,"records",q);k._buildDropList(q,i)},error:function(n,p,o){var m=l.onError;if(m){k._trigger("onError",null,n,p,o)}}};j.data[l.queryName]=i;c.ajax(j);var f=l.onSuggesting;if(f){k._trigger("onSuggesting",null,i)}}else{this.dropList.empty().hide()}},_buildDropList:function(e,k){var j=this.element;var d=this.dropList.empty().css("height","auto");var g=e.valueField?false:true;var l=this.options.clientFormatter;var m=this;if(g){if(l){c(e).each(function(n){m._addRow(l(this,n),d)})}else{c(e).each(function(n){m._addRow(this,d)})}}else{if(l){c(e.data).each(function(n){m._addRow(l(this,n),d)})}}var i=d.find("."+a);if(i.size()>0){d.parent().css("left",parseInt(j.offset().left)).css("top",j.offset().top+j.outerHeight());var h=this.options.listWidth;if(!h){d.parent().width(j.outerWidth())}else{if(h!=="auto"){d.parent().width(h)}}i.mouseover(function(){i.removeClass(b);c(this).addClass(b)}).mousedown(function(o){var n=d.find("."+b).index();m._select(n);d.hide();m._triggerOnSelect(o)});d.show();var f=this.options.listMaxHeight;if(f!=="auto"){if(d.height()>f){d.height(f).css("overflow","auto")}}d.scrollTop(0)}},_addRow:function(e,d){c('<div class="'+a+'">'+e+"</div>").appendTo(d)},_triggerOnSelect:function(g){var f=this.options.onSelect;if(f){var e=this.dropList.find("."+b).index();if(e<0){return}var d=c.data(this.element,"records"),h,i;if(d.valueField){h=d.data[e];i=h[d.valueField]}else{h=d[e];i=h}this._trigger("onSelect",g,h,i,e)}}})})(jQuery);