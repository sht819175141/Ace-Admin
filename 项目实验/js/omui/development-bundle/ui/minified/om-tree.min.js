(function(a){var b={open:"open",closed:"closed",expandable:"expandable",expandableHitarea:"expandable-hitarea",lastExpandableHitarea:"lastExpandable-hitarea",collapsable:"collapsable",collapsableHitarea:"collapsable-hitarea",lastCollapsableHitarea:"lastCollapsable-hitarea",lastCollapsable:"lastCollapsable",lastExpandable:"lastExpandable",last:"last",hitarea:"hitarea"};a.omWidget("om.omTree",{_swapClass:function(f,e,d){var c=f.filter("."+e);f.filter("."+d).removeClass(d).addClass(e);c.removeClass(e).addClass(d)},_getParentNode:function(d){if(d){var c=a(d).parent().parent();if(c&&c.hasClass("om-tree-node")){return c}}return null},_setParentCheckbox:function(e){var h=this._getParentNode(e);if(h){var g=h.find(">ul >li >div.tree-checkbox");var c=g.length;var i=g.filter(".checkbox_full").length;var d=g.filter(".checkbox_part").length;var f=h.find(">div.tree-checkbox");f.removeClass("checkbox_full checkbox_part");if(i==c){f.addClass("checkbox_full")}else{if(i>0||d>0){f.addClass("checkbox_part")}}this._setParentCheckbox(h)}},_setChildCheckbox:function(d,c){var e=d.find(">ul").find(".tree-checkbox");e.removeClass("checkbox_part checkbox_full");if(c){e.addClass("checkbox_full")}},_applyEvents:function(f){var j=this,k=j.options,h=k.onClick,d=k.onDblClick,i=k.onRightClick,e=k.onDrag,g=k.onSelect,c=k.onDrop;f.find("span").bind("click",function(m){var l=j.element.data("nodes")[a(this).parent().attr("id")];h&&j._trigger("onClick",m,l);j.select(l);return false}).bind("dblclick",function(n){var l=a(this).parent();var m=j.element.data("nodes")[l.attr("id")];if(l.hasClass("hasChildren")){l.find("span.folder").removeClass("folder").addClass("placeholder")}if(l.has("ul").length>0&&a(n.target,this)){j.toggler(l)}l.find("span.placeholder").removeClass("placeholder").addClass("folder");d&&j._trigger("onDblClick",n,m)}).bind("contextmenu",function(m){var l=j.element.data("nodes")[a(this).parent().attr("id")];i&&j._trigger("onRightClick",m,l)}).bind("mouseover mouseout",function(l){if(l.type=="mouseover"){a(this).addClass("hover")}else{if(l.type=="mouseout"){a(this).removeClass("hover")}}return false});j._bindHitEvent(f);f.find("div.tree-checkbox").click(function(n){var m=a(this).parent();var l=j.findByNId(m.attr("id"));j._toggleCheck(m,j.isCheck(l))});if(j.options.draggable){f.omDraggable({revert:"invalid",onStart:function(m,n){var l=j.findByNId(m.helper.attr("id"));e&&j._trigger("onDrag",n,l)}});f.omDroppable({greedy:true,accept:"li.om-tree-node",onDragOver:function(n,m){var l=f.filter(".treenode-droppable");if(l.length>0){l.removeClass("treenode-droppable")}else{a(this).addClass("treenode-droppable")}},onDragOut:function(m,l){a(this).removeClass("treenode-droppable")},onDrop:function(l,n){var r,s,t=l;var m=this;var q=m.find(">ul");a(this).removeClass("treenode-droppable");t.css("left","");t.css("top","");var o=j.findByNId(m.attr("id"));var u=j.findByNId(t.attr("id"));if(m.has("ul").length>0){r=o}else{s=o;u.pid=o.pid}var p=j.findByNId(t.parent().find("li").attr("id"));j.remove(u);j.insert(u,r,s,true);c&&j._trigger("onDrop",n,p)}})}f.bind("mousedown",function(l){l.stopPropagation()})},_bindHitEvent:function(d){var c=this;d.find("div.hitarea").click(function(){var e=a(this).parent();if(e.hasClass("hasChildren")){e.find("span.folder").removeClass("folder").addClass("placeholder")}c.toggler(e);e.find("span.placeholder").removeClass("placeholder").addClass("folder")})},options:{initExpandLevel:0,lineHover:false,showIcon:true,showLine:true,showCheckbox:false,cascadeCheck:true,draggable:false,filter:null,nodeCount:0,simpleDataModel:false},_create:function(){this.element.data("nodes",[]).data("selected","").data("init_dataSource",[]).addClass("om-tree om-widget")},updateNode:function(f){var d=this,e=d.options;var c=f.find("li");d._applyEvents(c);if(e.control){d._treeController(d,e.control)}},toggler:function(f){var j=this,k=j.options;var c=f.attr("id");var d=j.findByNId(c);var e=f.hasClass(b.expandable);if(e){var i=k.onBeforeExpand;if(i&&false===j._trigger("onBeforeExpand",null,d)){return j}}else{var g=k.onBeforeCollapse;if(g&&false===j._trigger("onBeforeCollapse",null,d)){return j}}var h=f.find(f.find(">.hitarea"));j._swapClass(h,b.collapsableHitarea,b.expandableHitarea);j._swapClass(h,b.lastCollapsableHitarea,b.lastExpandableHitarea);j._swapClass(f,b.collapsable,b.expandable);j._swapClass(f,b.lastCollapsable,b.lastExpandable);f.find(">ul").each(function(){if(e){a(this).show();var m=k.onExpand;m&&j._trigger("onExpand",null,d)}else{a(this).hide();var l=k.onCollapse;l&&j._trigger("onCollapse",null,d)}})},_init:function(){var c=this,d=c.options,f=c.element,e=d.dataSource;f.empty();if(e){if(typeof e=="string"){c._ajaxLoad(f,e)}else{if(typeof e=="object"){if(d.simpleDataModel){e=c._transformToNodes(e)}f.data("init_dataSource",e);c._appendNodes.apply(c,[f,e]);c.updateNode(f)}}}},_ajaxLoad:function(h,e){var c=this,d=this.options,g=d.onBeforeLoad,i=d.onSuccess,f=d.onError;g&&c._trigger("onBeforeLoad",null,c.findByNId(h.parent().attr("id")));a.ajax({url:e,method:"POST",dataType:"json",cache:false,success:function(j){if(d.simpleDataModel){j=c._transformToNodes(j)}h.data("init_dataSource",j);c._appendNodes.apply(c,[h,j]);c.updateNode(h);i&&c._trigger("onSuccess",null,j)},error:function(j,l,k){f&&c._trigger("onError",null,j,l,k)}})},check:function(c){this._toggleCheck(a("#"+c.nid),false)},uncheck:function(c){this._toggleCheck(a("#"+c.nid),true)},_toggleCheck:function(h,f){var g=h.find(">div.tree-checkbox"),c=this,d=c.options,e=d.onCheck;if(f){g.removeClass("checkbox_part checkbox_full")}else{g.removeClass("checkbox_part").addClass("checkbox_full")}if(c.options.cascadeCheck){c._setChildCheckbox(h,!f);c._setParentCheckbox(h)}e&&c._trigger("onCheck",null,c.findByNId(h.attr("id")))},checkAll:function(c){if(c){this.element.find(".tree-checkbox").removeClass("checkbox_part").addClass("checkbox_full")}else{this.element.find(".tree-checkbox").removeClass("checkbox_part checkbox_full")}},isCheck:function(c){return a("#"+c.nid).find(">div.tree-checkbox").hasClass("checkbox_full")},getChecked:function(f){var d=this,c=[];var e=f?".checkbox_full":":not(.checkbox_full)";this.element.find(".tree-checkbox").filter(e).each(function(h,g){c.push(d.element.data("nodes")[a(this).parent().attr("id")])});return c},select:function(i){var d=this,g=this.options,f=g.onBeforeSelect,e=g.onSelect;if(f&&false===d._trigger("onBeforeSelect",null,i)){return d}var h=a("#"+i.nid);a(" >span",h).addClass("selected");var j=d.element.data("selected");var c=h.attr("id");if(j!=""&&!(j==c)){a("#"+j+" >span").removeClass("selected")}d.element.data("selected",c);e&&d._trigger("onSelect",null,i)},unselect:function(f){var d=this;var e=a("#"+f.nid);a(" >span",e).removeClass("selected");var g=d.element.data("selected");var c=e.attr("id");if(g==c){d.element.data("selected","")}},getSelected:function(){var c=this.element.data("selected");return c?this.element.data("nodes")[c]:null},findNodes:function(h,k,g,e){var d=[],c;var j=g?g.children:this.element.data("init_dataSource");e=(e!=false)?true:e;if(j&&(c=j.length)>0){for(var f=0;f<c;f++){d=this._searchNode.apply(j[f],[h,k,this._searchNode,d,false,e])}}return d.length>0?d:null},findNode:function(h,k,g,d){var f,c,j=g?g.children:this.element.data("init_dataSource");d=(d!=false)?true:d;if(j&&(c=j.length)>0){for(var e=0;e<c;e++){f=this._searchNode.apply(j[e],[h,k,this._searchNode,[],true,d]);if(f!=null){return f}}}return null},findByNId:function(c){return this.element.data("nodes")[c]||null},findNodesBy:function(h,g,d){var f,j=g?g.children:this.element.data("init_dataSource");d=(d!=false)?true:d;var c=[];if(j&&(len=j.length)>0){for(var e=0;e<len;e++){if(h.call(j[e],j[e])===true){c.push(j[e])}if(d&&j[e].children){f=this.findNodesBy(h,j[e],d);if(f){c=c.concat(f)}}}}return c.length>0?c:null},findNodeBy:function(h,g,d){var f,j=g?g.children:this.element.data("init_dataSource");d=(d!=false)?true:d;if(j&&(c=j.length)>0){for(var e=0,c=j.length;e<c;e++){if(h.call(j[e],j[e])===true){return j[e]}if(d){f=this.findNodeBy(h,j[e],d);if(f!=null){return f}}}}return null},_searchNode:function(h,k,f,c,j,d){if(j){if(this[h]==k){return this}if(this.children&&this.children.length&&d){for(var g in this.children){var e=f.apply(this.children[g],[h,k,f,[],true,d]);if(e){return e}}}}else{if(this[h]==k){c.push(this)}if(this.children&&this.children.length&&d){a.each(this.children,f,[h,k,f,c,false,d])}return c}},getParent:function(d){var c=this.element.data("nodes")["pid"+d.nid];return c?this.findByNId(c):null},getChildren:function(c){return c.children},getData:function(){return this.options.dataSource},setData:function(c){this.options.dataSource=c},expand:function(f){if(f.nid){var d=b.expandable,e=a("#"+f.nid);var c=a(">div."+b.hitarea,e).filter(function(){return d?a(this).parent("."+d).length:true}).parent().parentsUntil(this.element).andSelf().filter(function(){return a(this).filter("li").hasClass(d)});this.toggler(c)}},collapse:function(c){if(c.nid){this._collapseHandler(b.collapsable,a("#"+c.nid))}},expandAll:function(){this._collapseHandler(b.expandable,this.element,true)},collapseAll:function(){this._collapseHandler(b.collapsable,this.element,true)},_collapseHandler:function(d,e,c){var f=(c?"":">")+"div."+b.hitarea;this.toggler(a(f,e).filter(function(){return d?a(this).parent("."+d).length:true}).parent())},refresh:function(k){var g=this,e=g.element;var j=g.getData();if(!k){e.empty();if(typeof j=="string"){g._ajaxLoad(e,j)}else{if(typeof j=="object"){g.setData([]);for(var h=0,d=j.length;h<d;h++){g.insert(j[h])}}}}else{var c=a("#"+k.nid).next();var f=e.data("nodes")["pid"+k.nid];g.remove(k);g.insert(k,g.findByNId(f),g.findByNId(c.attr("id")))}},_transformToNodes:function(g){var e,c;if(!g){return[]}var f=[];var h=[];for(e=0,c=g.length;e<c;e++){h[g[e]["id"]]=g[e]}for(e=0,c=g.length;e<c;e++){if(h[g[e]["pid"]]){var d=g[e]["pid"];if(!h[d]["children"]){h[d]["children"]=[]}h[d]["children"].push(g[e])}else{f.push(g[e])}}return f},_appendNodes:function(v,m,e,f){var j=this,t=[];var g=j.options.showCheckbox;var c=j.element.attr("id")?j.element.attr("id"):("treeId"+parseInt(Math.random()*1000));j.element.attr("id",c);for(var q=0,o=m.length;q<o;q++){var n=m[q],k=(q==(m.length-1));var w="om-tree-node "+(g?"treenode-checkable ":"")+(n.hasChildren?"hasChildren ":"");var h=c+"_"+(++j.options.nodeCount);n.nid=h;var d=j.element.data("nodes");d[n.nid]=n;if(typeof v=="string"){d["pid"+n.nid]=v;if(k){v=null}}else{d["pid"+n.nid]=v.parent("li").attr("id")}var u=[];if(n.children&&n.children.length>0){u.push((j._appendNodes(n.nid,n.children)).join(""))}var r=0;if(n.children&&(r=n.children.length)>0||n.hasChildren){if(n.expanded){w=w+"open "+b.collapsable+" "+(k?b.lastCollapsable:"")}else{w=w+b.expandable+" "+(k?b.lastExpandable:"")}}else{w=w+(k?b.last:"")}t.push("<li id='",n.nid,"' class='",w,"'>");if(n.hasChildren||r>0){var s="";a.each(w.split(" "),function(){s+=this+"-hitarea "});t.push("<div class='",b.hitarea+" "+s,"'/>")}if(g){t.push("<div class='tree-checkbox'/>")}var p=(n.classes?n.classes:"");if(j.options.showIcon){if(n.hasChildren||n.children&&n.children.length>0){p=p+" folder "}else{p=p+" file "}}t.push("<span class='",p,"'>","<a href='#'>",n.text,"</a></span>");if(n.hasChildren||r>0){t.push("<ul"," style='display:",(n.expanded?"block":"none"),"'>");t.push(u.join(""));t.push("</ul>")}t.push("</li>")}if(e){if(f){a("#"+e.nid).after(t.join(""))}else{a("#"+e.nid).before(t.join(""))}}else{if(v){v.append(t.join(""))}}return t},remove:function(j,l){var k,m=this,f=l?l.children:m.element.data("init_dataSource");for(var g in f){if(f[g]==j){var c=[];c=m._findChildrenId(j,c);c.push(j.nid);for(var d=0,h=c.length;d<h;d++){delete m.element.data("nodes")[c[d]];delete m.element.data("nodes")["pid"+c[d]]}if(j.nid==m.element.data("selected")){this.element.data("selected",null)}var e=a("#"+j.nid).prev();if(a("#"+j.nid).next().length<1&&e.length>0){if(e.hasClass(b.collapsable)){e.addClass(b.lastCollapsable);e.find("div.hitarea").first().addClass(b.lastCollapsableHitarea)}else{if(e.hasClass(b.expandable)){e.addClass(b.lastExpandable);e.find("div.hitarea").first().addClass(b.lastExpandableHitarea)}else{e.addClass(b.last)}}}a("#"+j.nid).remove();f.splice(g,1);if(l&&l.nid&&f.length<1){m._changeToFolderOrFile(l,false)}return true}else{if(f[g].children){k=m.remove(j,f[g]);if(k){return true}}}}return false},_findChildrenId:function(g,f){if(g.children){for(var e=0,d=g.children,c=d.length;e<c;e++){f.push(d[e].nid);if(d[e].children){this._findChildrenId(d[e],f)}}}return f},insert:function(j,o,c,l){if(!j){return}var p=this,d=[],n,h,k=a.isArray(j);if(k){d=j}else{d.push(j)}if(c){o=o||p.findByNId(p.element.data("nodes")["pid"+c.nid])}var i,g=o?o.children:p.element.data("init_dataSource");if(o&&(!o.children||o.children.length<1)){if(!o.hasChildren){p._changeToFolderOrFile(o,true);p._bindHitEvent(a("#"+o.nid))}g=o.children=[]}n=o?a("#"+o.nid).children("ul").first():p.element;h=n.find("li");if(c&&((i=a.inArray(c,g))>=0)){p._appendNodes(n,d,c,l);g.splice(i,0,j)}else{p._appendNodes(n,d,c,l);if(k){a.merge(g,j)}else{g.push(j)}}var f=n.find("li").filter("."+b.last+",."+b.lastCollapsable+",."+b.lastExpandable).not(n.find("li").filter(":last-child:not(ul)"));f.removeClass(b.last+" "+b.lastCollapsable+" "+b.lastExpandable);f.find(" >div").removeClass(b.lastCollapsableHitarea+" "+b.lastExpandableHitarea);var e=n.find("li").not(h);p._applyEvents(e)},_changeToFolderOrFile:function(g,h){var f=a("#"+g.nid),d=this;if(h){var e=a("<ul/>").css("display","block").appendTo(f);f.addClass("open "+b.collapsable);d._swapClass(f,b.last,b.lastCollapsable);g.children=[]}else{f.find("ul").remove();f.find("div."+b.hitarea).remove();f.filter("."+b.lastCollapsable+",."+b.lastExpandable).removeClass(b.lastCollapsable+" "+b.lastExpandable).addClass(b.last);f.removeClass("open "+b.collapsable+" "+b.expandable)}if(d.options.showIcon){d._swapClass(f.children("span"),"file","folder")}var c=f.filter(":has(>ul)").prepend('<div class="'+b.hitarea+'"/>').find("div."+b.hitarea);c.each(function(){var i="";a.each(a(this).parent().attr("class").split(" "),function(){i+=this+"-hitarea "});a(this).addClass(i)})},modify:function(h,f,e){if(h&&f){var d=this,c=a("#"+h.nid).next(),g;e=e||this.findByNId(d.element.data("nodes")["pid"+h.nid]);if(c.is("ul")||c.is("li")){g=d.findByNId(c.attr("id"))}d.remove(h,e);d.insert(f,e,g)}},disable:function(){},enable:function(){}})})(jQuery);