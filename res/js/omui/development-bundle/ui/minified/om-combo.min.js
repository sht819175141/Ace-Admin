(function(a){if(!Array.prototype.indexOf){Array.prototype.indexOf=function(d){var b=this.length;for(var c=0;c<b;c++){if(this[c]===d){return c}}return -1}}a.omWidget("om.omCombo",{options:{optionField:"text",valueField:"value",width:"auto",disabled:false,readOnly:false,editable:true,lazyLoad:false,listMaxHeight:300,listAutoWidth:false,autoFilter:true,filterStrategy:"first",filterDelay:500,forceSelection:false,multi:false,multiSeparator:","},_init:function(){var b=this.options,e=this.textInput,d=b.dataSource;if(!b.inputField){b.inputField=b.optionField}if(typeof b.value!=="undefined"){b.lazyLoad=false}if(b.width!="auto"){var c=e.parent().width(b.width);e.width(c.innerWidth()-e.next().outerWidth()-e.outerWidth()+e.width())}if(b.multi){b.editable=this.options.editable=false}this._refeshEmptyText(b.emptyText);b.disabled?e.attr("disabled",true):e.removeAttr("disabled");(b.readOnly||!b.editable)?e.attr("readonly","readOnly"):e.removeAttr("readonly");if(!b.lazyLoad){this._toggleLoading("add");if(d&&typeof d=="string"){this._ajaxLoad(d)}else{if(d&&typeof d=="object"){this._loadData(d);this._toggleLoading("remove")}else{this.dataHasLoaded=true;this._toggleLoading("remove")}}}else{this.dataHasLoaded=false}var f=b.disabled||b.readOnly;if(f){this.expandTrigger.addClass("om-state-disabled")}else{this._bindEvent()}},_create:function(){var c=this.element;var b=a('<span class="om-combo om-widget om-state-default"></span>').insertAfter(c).wrapInner(c);this.textInput=c.clone().removeAttr("id").removeAttr("name").appendTo(b);this.expandTrigger=a('<span class="om-combo-trigger"></span>').appendTo(b);c.hide();this.dropList=a(a('<div class="om-widget"><div class="om-widget-content om-droplist"></div></div>').css({position:"absolute",zIndex:2000}).appendTo(document.body).children()[0]).hide()},setData:function(e){var b=this,d=b.textInput,c=b.element;b.options.value="";c.val("");d.val("");b._toggleLoading("add");if(typeof e==="string"){b._ajaxLoad(e)}else{b._loadData(e);b._toggleLoading("remove")}},getData:function(){var b=this.options.dataSource;return(typeof b=="object")?b:null},value:function(b){if(typeof b==="undefined"){var c=this.element.val();return c?c:""}else{this._setValue(b+"");return this}},disable:function(){var b=this.element;b.attr("disabled",true).unbind();this.options.disabled=true;this.expandTrigger.addClass("om-state-disabled").unbind()},enable:function(){var b=this.element;b.removeAttr("disabled").unbind();this.options.disabled=false;this.expandTrigger.removeClass("om-state-disabled").unbind();this._bindEvent()},destroy:function(){var b=this.element;a(document).unbind("mousedown.omCombo",this.globalEvent);b.parent().after(b).remove();this.dropList.parent().remove()},_bindEvent:function(){var i=this,j=i.options,e=i.textInput,c=i.element,b=i.dropList,g=i.expandTrigger,d=j.emptyText;var h=false,f=e.parent("span");f.mouseenter(function(){if(!j.disabled){f.addClass("om-state-hover")}}).mouseleave(function(){f.removeClass("om-state-hover")}).mousedown(function(k){k.stopPropagation()});e.focus(function(){if(h){return}h=true;a(".om-droplist").hide();f.addClass("om-state-focus");i._refeshEmptyText(d);if(!i.dataHasLoaded){if(!g.hasClass("om-loading")){i._toggleLoading("add");if(typeof(j.dataSource)=="object"){i._loadData(j.dataSource);i._toggleLoading("remove")}else{if(typeof(j.dataSource)=="string"){i._ajaxLoad(j.dataSource)}else{i.dataHasLoaded=true;i._toggleLoading("remove")}}}}if(!j.disabled&&!j.readOnly){i._showDropList()}}).blur(function(n){h=false;f.removeClass("om-state-focus");e.removeClass("om-combo-focus");if(!j.disabled&&!j.readOnly&&!j.multi){if(i.hasManualInput){i.hasManualInput=false;var o=e.val();if(o!==""){var p=a.data(c,"allInputText");var k=a.data(c,"allValues");var l=p.indexOf(o);if(l>-1){i._setValue(k[l])}else{if(!j.forceSelection){c.val(e.val())}else{var m=c.val();l=k.indexOf(m);if(l>-1){e.val(p[l])}else{e.val("")}}}}else{c.val("")}}i._refeshEmptyText(d)}}).keyup(function(m){var k=m.keyCode,l=a.om.keyCode;switch(k){case l.DOWN:i._selectNext();break;case l.UP:i._selectPrev();break;case l.ENTER:i._backfill(i.dropList.find(".om-state-hover"));break;case l.ESCAPE:b.hide();break;case l.TAB:break;default:i.hasManualInput=true;if(!j.disabled&&!j.readOnly&&j.editable&&j.autoFilter){if(window._omcomboFilterTimer){clearTimeout(window._omcomboFilterTimer)}window._omcomboFilterTimer=setTimeout(function(){if(a(document).attr("activeElement").id==e.attr("id")){b.show()}i._doFilter(e)},j.filterDelay)}}});b.mousedown(function(k){k.stopPropagation()});g.click(function(){!g.hasClass("om-loading")&&e.focus()}).mousedown(function(){!g.hasClass("om-loading")&&f.addClass("om-state-active")}).mouseup(function(){!g.hasClass("om-loading")&&f.removeClass("om-state-active")});a(document).bind("mousedown.omCombo",this.globalEvent=function(){b.hide()})},_showDropList:function(){var p=this,r=p.options,n=p.textInput,o=p.element,b=p.dropList.scrollTop(0).css("height","auto"),q,e=o.val(),k=b.find(".om-combo-list-row"),h=p._getAllOptionsBeforeFiltered().removeClass("om-helper-hidden om-state-hover");if(h.size()<=0){return}k.removeClass("om-combo-selected");if(e!==undefined&&e!==""){var c=a.data(o,"allValues");if(r.multi){var j=e.split(r.multiSeparator);for(var d=0;d<j.length;d++){var f=c.indexOf(j[d]);if(f>-1){a(b.find(".om-combo-list-row").get(f)).addClass("om-combo-selected")}}valueItem=j[0]}else{var f=c?c.indexOf(e):-1;if(f>-1){q=a(b.find(".om-combo-list-row").get(f)).addClass("om-combo-selected")}}}var m=b.parent(),l=n.parent();if(!r.listAutoWidth){m.width(l.outerWidth())}else{if(a.browser.msie&&(a.browser.version=="7.0")&&!a.support.style){m.width(b.show().outerWidth())}else{m.width(b.outerWidth())}}if(r.listMaxHeight!="auto"&&b.show().height()>r.listMaxHeight){b.height(r.listMaxHeight).css("overflow-y","auto")}var g=l.offset();m.css({left:g.left,top:g.top+l.outerHeight()});b.show();if(q){b.scrollTop(a(q).offset().top-b.offset().top)}},_toggleLoading:function(b){if(!this.options.disabled){if(b=="add"){this.expandTrigger.removeClass("om-icon-carat-1-s").addClass("om-loading")}else{if(b=="remove"){this.expandTrigger.removeClass("om-loading").addClass("om-icon-carat-1-s")}}}},_ajaxLoad:function(d){var b=this;var c=this.options;a.ajax({url:d,method:"POST",dataType:"json",success:function(e,g){b.dataHasLoaded=true;var f=c.onSuccess;if(f&&b._trigger("onSuccess",null,e,g)===false){c.dataSource=e;return}b._loadData(e);b._toggleLoading("remove")},error:function(e,g,f){b.dataHasLoaded=true;if(c.onError){b._toggleLoading("remove");b._trigger("onError",null,e,g,f)}else{b._toggleLoading("remove");throw new Error('An error occurred while load records from URL "'+d+'",the error message is:'+f.message)}}})},_loadData:function(g){var m=this.options,e=this.element;m.dataSource=g;this.dataHasLoaded=true;var f=m.inputField;var h=[];if(typeof f==="string"){a(g).each(function(){h.push(this[f])})}else{a(g).each(function(n){h.push(f(this,n))})}a.data(e,"allInputText",h);var l=m.valueField;var c=[];if(typeof l==="string"){a(g).each(function(){c.push(""+this[l])})}else{a(g).each(function(n){c.push(""+l(this,n))})}a.data(e,"allValues",c);var b=this.dropList.empty();if(m.listProvider){var j=m.listProvider(b,g);if(j){j.each(function(){a(this).addClass("om-combo-list-row")})}}else{var i=m.optionField;var d="";var k=this;if(typeof i==="string"){a(g).each(function(n){d+=k._wrapText(this[m.optionField])})}else{a(g).each(function(n){d+=k._wrapText(m.optionField(this,n))})}if(d){a(d).appendTo(b);b.show().css("height","auto");if(m.listMaxHeight!="auto"&&b.height()>m.listMaxHeight){b.height(m.listMaxHeight).css("overflow-y","auto")}b.hide();if(e.parent().hasClass("om-state-hover")){k._showDropList()}}}if(m.value){this._setValue(""+m.value)}this._bindEventsToList()},_bindEventsToList:function(){var c=this,b=c._getAllOptionsBeforeFiltered();b.hover(function(){b.removeClass("om-state-hover");a(this).addClass("om-state-hover")},function(){a(this).removeClass("om-state-hover")}).mousedown(function(){c._backfill(this)})},_wrapText:function(b){return'<div class="om-combo-list-row">'+b+"</div>"},_setValue:function(k){var j=this.textInput,d=this.element;var f=true;var b=d.val();var m=this.options;if(k==b){f=false}var c=a.data(d,"allValues");var g=[],l=[];if(m.multi){l=k.split(m.multiSeparator)}else{l.push(k)}for(var e=0;e<l.length;e++){var h=c?c.indexOf(l[e]):-1;if(h>-1){g.push(a.data(d,"allInputText")[h])}else{if(!m.forceSelection){g.push(k)}else{d.val("");k=""}}}d.val(k);if(m.multi){j.val(g.join(m.multiSeparator))}else{j.val(g.join(""))}m.value=k;if(m.onValueChange&&f){this._trigger("onValueChange",null,j,k,b)}this._refeshEmptyText(m.emptyText)},_findHighlightItem:function(){var b=this.dropList;var c=b.find(".om-state-hover");if(c.length>0){return c}var d=b.find(".om-combo-selected");return d.length>0?d[0]:d},_selectPrev:function(){var b=this._findHighlightItem();var d=this._getAllOptionsAfterFiltered();var f=d.index(b);var c=a(d[f]);if(f===0){f=d.length}else{if(f==-1){f=d.length}}var e=a(d[f-1]);this._highLisghtAndScrollTo(c,e)},_selectNext:function(){var d=this.dropList;if(d.css("display")=="none"){this._showDropList();return}var e=this._getAllOptionsAfterFiltered();var f=e.index(this._findHighlightItem());var c=a(e[f]);if(f==e.length-1){f=-1}var b=a(e[f+1]);this._highLisghtAndScrollTo(c,b)},_highLisghtAndScrollTo:function(c,d){var b=this.dropList;c.removeClass("om-state-hover");d.addClass("om-state-hover");if(d.position().top<=0){b.scrollTop(b.scrollTop()+d.position().top)}else{if(d.position().top+d.outerHeight()>b.height()){b.scrollTop(b.scrollTop()+d.position().top+d.outerHeight()-b.height())}}},_backfill:function(b){if(b.length===0){return}var k=this,e=k.element,c=k.dropList,l=k.options,d=l.multi;if(d){a(b).toggleClass("om-combo-selected").removeClass("om-state-hover")}else{this._getAllOptionsBeforeFiltered().removeClass("om-combo-selected");a(b).addClass("om-combo-selected")}if(c.css("display")=="none"){return}var j=[],h=c.find(".om-combo-selected");for(var g=0;g<h.length;g++){var f=a(h[g]).index();if(f>-1){j.push(a.data(e,"allValues")[f])}}this._setValue(j.join(d?l.multiSeparator:""));if(!d){c.hide()}},_getAllOptionsBeforeFiltered:function(){return this.dropList.find(".om-combo-list-row")},_getAllOptionsAfterFiltered:function(){var b=this.dropList;return b.find(".om-combo-list-row").not(b.find(".om-helper-hidden"))},_doFilter:function(){var b=this,f=b.textInput,e=b.element,c=b.options;records=c.dataSource,filterStrategy=c.filterStrategy,text=f.val(),needShow=false,items=b._getAllOptionsBeforeFiltered(),allInputText=a.data(e,"allInputText");a(records).each(function(g){if(b._filetrPass(filterStrategy,text,records[g],allInputText[g])){a(items.get(g)).removeClass("om-helper-hidden");needShow=true}else{a(items.get(g)).addClass("om-helper-hidden")}});var d=this.dropList.css("height","auto");if(c.listMaxHeight!="auto"&&d.height()>c.listMaxHeight){d.height(c.listMaxHeight).css("overflow-y","auto")}if(!needShow){d.hide()}},_filetrPass:function(d,f,b,e){if(f===""){return true}if(typeof d==="function"){return d(f,b)}else{if(d==="first"){return e.indexOf(f)===0}else{if(d==="anywhere"){return e.indexOf(f)>-1}else{if(d==="last"){var c=e.lastIndexOf(f);return c>-1&&c+f.length==e.length}else{return false}}}}},_refeshEmptyText:function(b){var c=this.textInput;if(!b){return}if(c.val()===""){c.val(b).addClass("om-empty-text")}else{if(c.val()===b){c.val("")}c.removeClass("om-empty-text")}}})})(jQuery);