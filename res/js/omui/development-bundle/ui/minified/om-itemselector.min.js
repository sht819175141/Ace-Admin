(function(a){a.omWidget("om.omItemSelector",{options:{width:"300px",height:"300px",dataSource:[],value:[],clientFormatter:false,autoSort:false,preProcess:function(b){return b},onError:jQuery.noop,onSuccess:jQuery.noop,onBeforeItemSelect:jQuery.noop,onBeforeItemDeselect:jQuery.noop,onItemSelect:jQuery.noop,onItemDeselect:jQuery.noop},_create:function(){this.element.addClass("om-itemselector om-widget").html('<table style="height:100%;width:100%" cellpadding="0" cellspacing="0"><tr><td class="om-itemselector-leftpanel"></td><td class="om-itemselector-toolbar"></td><td class="om-itemselector-rightpanel"></td></tr></table>');var c=a("td",this.element);var d=a("<thead></thead>");var b=a("<th></th>").attr({axis:"checkboxCol",align:"center"}).append(a('<div class="header"><span class="checkbox"/><span class="om-itemselector-title"/></div>'));a("<tr></tr>").append(b).appendTo(d);this.leftPanel=a('<table cellspacing="0" cellpadding="0"></table>').append(d).append('<tr><td><div class="om-itemselector-up"><span class="upbtn"/></div><div class="om-itemselector-items"><dl></dl></div><div class="om-itemselector-down"><span class="downbtn"/></div></tr></td>').appendTo(c.eq(0));this.toolbar=a("<div></div>").appendTo(c.eq(1));this.rightPanel=this.leftPanel.clone().appendTo(c.eq(2))},_init:function(){var d=this.options,c=d.dataSource;this.leftPanel.find(".om-itemselector-title").html(a.om.lang._get(d,"omItemSelector","availableTitle"));this.rightPanel.find(".om-itemselector-title").html(a.om.lang._get(d,"omItemSelector","selectedTitle"));this.element.css({width:d.width,height:d.height});this._buildToolbar();this._resizePanel();this._bindEvents();if(typeof c==="string"){var b=this;a.ajax({url:c,method:"GET",dataType:"json",success:function(e,f){if(b._trigger("onSuccess",null,e,f)===false){return}e=d.preProcess(e);d.dataSource=e;b._buildList()},error:function(e,g,f){b._trigger("onError",null,e,g,f)}})}else{this._buildList()}this._refreshPageButton(this.leftPanel);this._refreshPageButton(this.rightPanel)},_buildToolbar:function(){var d="",f=["add","space","remove"];for(var c=0,b=f.length;c<b;c++){var e=f[c];d+='<div class="om-icon om-itemselector-tbar-'+e+'" title="'+(a.om.lang._get({},"omItemSelector",e+"IconTip")||"")+'"></div>'}this.toolbar.html(d)},_resizePanel:function(){var d=this,f=d.leftPanel,g=d.rightPanel,c=a(".om-itemselector-items",f),i=a(".om-itemselector-items",g),e=f.parent().innerHeight()-c.offset().top+f.offset().top,b=(a("tr",d.element).innerWidth()-d.toolbar.outerWidth())/2,h=f.outerWidth(b).innerWidth();c.outerHeight(e).width(h);i.outerHeight(e).width(h);d.element.data("dltop",a(".om-itemselector-items >dl",f).offset().top)},_buildList:function(){var f=this.options;dataSource=f.dataSource,value=f.value,fmt=f.clientFormatter,leftHtml="",rightHtml="",inArray=function(k,h){for(var j=0,g=h.length;j<g;j++){if(k.value===h[j]){return true}}return false},buildHtml=fmt?function(g,h){return'<dt _index="'+g+'"><span class="checkbox"/>'+fmt(h,g)+"</dt>"}:function(g,h){return'<dt _index="'+g+'"><span class="checkbox"/>'+h.text+"</dt>"};if(a.isArray(dataSource)&&jQuery.isArray(value)){a.each(dataSource,function(g,h){if(inArray(h,value)){rightHtml+=buildHtml(g,h)}else{leftHtml+=buildHtml(g,h)}})}a(".om-itemselector-items>dl",this.leftPanel).html(leftHtml);a(".om-itemselector-items>dl",this.rightPanel).html(rightHtml);var c=a(".om-itemselector-items"),b=a(">dl>dt",c).outerHeight(),d=c.outerHeight(),e=b-d%b;c.outerHeight(d+e)},_bindEvents:function(){var b=this,c=b.toolbar;b.leftPanel.delegate(".om-itemselector-items>dl>dt","click.omItemSelector",function(d){a(this).toggleClass("om-state-highlight");b._refreshHeaderCheckbox(b.leftPanel)});b.rightPanel.delegate(".om-itemselector-items>dl>dt","click",function(d){a(this).toggleClass("om-state-highlight");b._refreshHeaderCheckbox(b.rightPanel)});this.leftPanel.delegate(".om-itemselector-items>dl>dt","dblclick",function(){a(".om-itemselector-items>dl>dt",b.element).removeClass("om-state-highlight");a(this).addClass("om-state-highlight");b._moveItemsToTarget(".om-state-highlight",true)});this.rightPanel.delegate(".om-itemselector-items>dl>dt","dblclick",function(){a(".om-itemselector-items>dl>dt",b.element).removeClass("om-state-highlight");a(this).addClass("om-state-highlight");b._moveItemsToTarget(".om-state-highlight",false)});a(".om-itemselector-tbar-add",c).click(function(){b._moveItemsToTarget(".om-state-highlight",true)});a(".om-itemselector-tbar-remove",c).click(function(){b._moveItemsToTarget(".om-state-highlight",false)});a(".header span.checkbox",b.leftPanel).click(function(){var d=b.leftPanel,e=a(".om-itemselector-items>dl>dt",d);a(this).toggleClass("selected");if(a("div.om-itemselector-up:visible",d).length>0){e=a(b._getPageItems(d,e))}if(a(this).hasClass("selected")){e.addClass("om-state-highlight")}else{e.removeClass("om-state-highlight")}});a(".header span.checkbox",b.rightPanel).click(function(){var d=b.rightPanel,e=a(".om-itemselector-items>dl>dt",d);a(this).toggleClass("selected");if(a("div.om-itemselector-up:visible",d).length>0){e=a(b._getPageItems(d,e))}if(a(this).hasClass("selected")){e.addClass("om-state-highlight")}else{e.removeClass("om-state-highlight")}});b.element.delegate("div.om-itemselector-up:not([disabled])","click",function(){b._page(a(this),true);b._refreshHeaderCheckbox(a(this).parentsUntil("table").last().parent())});b.element.delegate("div.om-itemselector-down:not([disabled])","click",function(){b._page(a(this),false);b._refreshHeaderCheckbox(a(this).parentsUntil("table").last().parent())})},_page:function(e,c){var i=c?e.next():e.prev(),f=i.children("dl"),g=i.outerHeight()-2,b=f.outerHeight(),k=f.offset().top,d,j=this.element.data("dltop")+20;if(c){f.offset({top:k+g});d=i.next();if((k=f.offset().top)>0||(f.outerHeight()-k-j)>g){d.removeAttr("disabled").removeClass("om-itemselector-down-disabled")}if(k>0&&k<g){e.attr("disabled","disabled").addClass("om-itemselector-up-disabled")}}else{f.offset({top:k-g});d=i.prev();d.removeAttr("disabled").removeClass("om-itemselector-up-disabled");if((k=f.offset().top)<0&&(b+k-j)<=g){e.attr("disabled","disabled").addClass("om-itemselector-down-disabled")}}},_refreshHeaderCheckbox:function(b){var d=a(".om-itemselector-items>dl>dt",b);d=a(this._getPageItems(b,d));var c=d.filter(".om-state-highlight").length;a(".header span.checkbox",b).toggleClass("selected",c>0&&d.length===c)},_refreshPageButton:function(c){var g=a(".om-itemselector-items",c),e=a(".om-itemselector-items >dl",c),d=a(".om-itemselector-up",c),i=a(".om-itemselector-down",c),f=g.outerHeight(),b=e.outerHeight(),j=e.offset().top,h=this.element.data("dltop")+20;if(b>20&&(h-j)>=b){e.offset({top:j+f});j=e.offset().top}if(b>f){if(d.is(":hidden")){g.outerHeight(f-d.outerHeight()*2);d.show();i.show()}if(j>0&&j<f){d.attr("disabled","disabled").addClass("om-itemselector-up-disabled")}else{d.removeAttr("disabled").removeClass("om-itemselector-up-disabled")}if(j>0||(b+j-h)>(f)){i.removeAttr("disabled").removeClass("om-itemselector-down-disabled")}else{i.attr("disabled","disabled").addClass("om-itemselector-down-disabled")}}else{if(d.is(":visible")){g.outerHeight(f+d.outerHeight()*2);d.hide();i.hide()}}},_getPageItems:function(b,l){var i=a(".om-itemselector-items",b),f=i.outerHeight(),e=a(">dl",i),d=[],h=i.next(":visible").length>0,c=l.outerHeight(),g=f/c,k=e.offset().top,j=this.element.data("dltop");k=h?j-k+20:j-k;d=a.grep(l,function(o,m){return m<g*(k/f+1)-1&&m>=g*(k/f)});return d},select:function(d){if(!a.isArray(indexes)){indexes=[indexes]}for(var c=0,b=d.length;c<b;c++){a('.om-itemselector-items>dl>dt[_index="'+d[c]+'"]').addClass("om-state-highlight")}},_moveItemsToTarget:function(c,d){var e=this,f=d?this.leftPanel:this.rightPanel,i=a(".om-itemselector-items>dl>dt"+c,f);if(i.size()==0){return}var g=d?this.rightPanel:this.leftPanel,h=this.options,b=[];i.each(function(){b.push(h.dataSource[a(this).attr("_index")])});if(d){if(e._trigger("onBeforeItemSelect",null,b)===false){return}i.appendTo(a(".om-itemselector-items>dl",g)).removeClass("om-state-highlight");e._trigger("onItemSelect",null,b)}else{if(e._trigger("onBeforeItemDeselect",null,b)===false){return}i.appendTo(a(".om-itemselector-items>dl",g)).removeClass("om-state-highlight");e._trigger("onItemDeselect",null,b)}e._refreshHeaderCheckbox(f);e._refreshPageButton(f);e._refreshPageButton(g)},value:function(c){if(arguments.length==0){var e=this.options,d=a(".om-itemselector-items>dl>dt",this.rightPanel),b=[];d.each(function(){b.push(e.dataSource[a(this).attr("_index")].value)});return b}else{if(a.isArray(c)){this.options.value=c;this._buildList()}}}});a.om.lang.omItemSelector={availableTitle:"可选项",selectedTitle:"已选项",addIconTip:"右移",removeIconTip:"左移"}})(jQuery);