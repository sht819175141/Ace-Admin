(function(a){a.omWidget("om.omGrid",{options:{height:462,width:"100%",colModel:false,autoFit:false,showIndex:true,dataSource:false,extraData:{},method:"GET",preProcess:false,limit:15,rowClasses:["oddRow","evenRow"],singleSelect:true,title:"",onRowSelect:function(d,c,b){},onRowDeselect:function(d,c,b){},onRowClick:function(d,c,b){},onRowDblClick:function(d,c,b){},onPageChange:function(c,b,d){},onSuccess:function(e,b,d,c){},onError:function(c,e,d,b){},onRefresh:function(d,b,c){},_onRefreshCallbacks:[],_onResizableCallbacks:[],_onResizeCallbacks:[]},_create:function(){var b=this.options,d=this.element.show().attr({cellPadding:0,cellSpacing:0,border:0}).empty().append("<tbody></tbody>");d.wrap('<div class="om-grid om-widget om-widget-content"><div class="bDiv" style="width:auto"></div></div>').closest(".om-grid");if(!a.isArray(this._getColModel())){return}this.hDiv=a('<div class="hDiv om-state-default"></div>').append('<div class="hDivBox"><table cellPadding="0" cellSpacing="0"></table></div>');d.parent().before(this.hDiv);this.pDiv=a('<div class="pDiv om-state-default"></div>');d.parent().after(this.pDiv);var c=d.closest(".om-grid");this.loadMask=a('<div class="gBlock"><div align="center" class="gBlock-valignMiddle" ><div class="loadingImg" style="display:block"/></div></div>').mousedown(function(f){return false}).hide();c.append(this.loadMask);this.titleDiv=a("<div class='titleDiv'></div>");c.prepend(this.titleDiv);this.tbody=this.element.children().eq(0);this._guid=0;b._onRefreshCallbacks.push(function(){this._refreshHeaderCheckBox()});this._bindScrollEnvent()},_init:function(){var c=this.element,d=this.options,b=c.closest(".om-grid");this._measure(b,d);if(!a.isArray(this._getColModel())){return}this._extraData={};this.tbody.empty();a("table",this.hDiv).empty();this.pDiv.empty();this.titleDiv.empty();this._buildTableHead();this._buildPagingToolBar();this._buildLoadMask();this._bindSelectAndClickEnvent();this._makeColsResizable();this._buildTitle();this._resetHeight();this.pageData={nowPage:1,totalPages:1};this._populate()},resize:function(d){var e=this,g=this.options,c=this.element.closest(".om-grid"),f,b;d=d||{};g.width=d.width||arguments[0]||g.width;g.height=d.height||arguments[1]||g.height;this._measure(c,g);this._buildLoadMask();this._resetWidth();this._resetHeight();a.each(g._onResizeCallbacks,function(h,i){i.call(e)})},_measure:function(b,c){b.outerWidth(c.width==="fit"?b.parent().width():c.width);b.outerHeight(c.height==="fit"?b.parent().height():c.height)},_resetHeight:function(){var e=this.element,b=e.closest(".om-grid");var c=this.hDiv.outerHeight(true),d=this.pDiv.is(":hidden")?0:this.pDiv.outerHeight(true),f=this.titleDiv.is(":hidden")?0:this.titleDiv.outerHeight(true);b.children(".bDiv").outerHeight(b.height()-c-d-f)},_resetWidth:function(){var g=this.options,e=this._getColModel(),c=-1,b=this.element.closest(".om-grid"),f=a("thead",this.hDiv),h=0;a.each(e,function(j,i){var k=i.width||60;if(i.width=="autoExpand"){k=0;c=j}f.find("th[axis='col"+j+"'] >div").width(k);h+=k});this._fixHeaderWidth(c,h);var d={};a(this._getHeaderCols()).each(function(){d[a(this).attr("abbr")]=a("div",a(this)).width()});this.tbody.find("td[abbr]").each(function(j,k){var i=a(k).prop("abbr");if(d[i]!=null){a(k).find(">div:first").width(d[i])}})},_getColModel:function(){return this.options.colModel},_buildTitle:function(){var b=this.titleDiv;if(this.options.title){b.html("<div class='titleContent'>"+this.options.title+"</div>").show()}else{b.empty().hide()}},_fixHeaderWidth:function(c,k){var l=this.element.closest(".om-grid"),i=a("thead",this.hDiv),j=this._getColModel(),d=this.options;if(c!=-1){var g=l.width()-32,e=i.find('th[axis="col'+c+'"] div');e.parent().hide();var f=g-i.width();e.parent().show();if(f<=0){e.css("width",60)}else{e.css("width",f)}}else{if(d.autoFit){var g=l.width()-22,f=g-i.width(),h=1+f/k,b=i.find('th[axis^="col"] >div');a.each(j,function(m){var n=b.eq(m);n.width(parseInt(n.width()*h))})}}},_buildTableHead:function(){var j=this.options,f=this.element,b=f.closest(".om-grid"),m=this._getColModel(),p=0,g=0,r=0,d=-1;thead=a("<thead></thead>");tr=a("<tr></tr>").appendTo(thead);if(j.showIndex){var q=a("<th></th>").attr({axis:"indexCol",align:"center"}).addClass("indexCol").append(a('<div class="indexheader" style="text-align:center;width:25px;"></div>'));tr.append(q);g=25}if(!j.singleSelect){var q=a("<th></th>").attr({axis:"checkboxCol",align:"center"}).addClass("checkboxCol").append(a('<div class="checkboxheader" style="text-align:center;width:17px;"><span class="checkbox"/></div>'));tr.append(q);r=17}for(var h=0,l=m.length;h<l;h++){var o=m[h],c=o.width||60,k=o.align||"center";if(c=="autoExpand"){c=0;d=h}var n=a("<div></div>").html(o.header).css({"text-align":k,width:c});o.wrap&&n.addClass("wrap");var e=a("<th></th>").attr("axis","col"+h).addClass("col"+h).append(n);if(o.name){e.attr("abbr",o.name)}if(o.align){e.attr("align",o.align)}p+=c;tr.append(e)}f.prepend(thead);a("table",this.hDiv).append(thead);this._fixHeaderWidth(d,p);this.thead=thead;thead=null},_buildPagingToolBar:function(){var f=this.options;if(f.limit<=0){this.pDiv.css("border-width",0).hide();this.pager=this.pDiv;return}var c=this,d=this.element,b=this.pDiv;b.show().html('<div class="pDiv2"><div class="pGroup"><div class="pFirst pButton om-icon"><span class="om-icon-seek-start"></span></div><div class="pPrev pButton om-icon"><span class="om-icon-seek-prev"></span></div></div><div class="btnseparator"></div><div class="pGroup"><span class="pControl"></span></div><div class="btnseparator"></div><div class="pGroup"><div class="pNext pButton om-icon"><span class="om-icon-seek-next"></span></div><div class="pLast pButton om-icon"><span class="om-icon-seek-end"></span></div></div><div class="btnseparator"></div><div class="pGroup"><div class="pReload pButton om-icon"><span class="om-icon-refresh"></span></div></div><div class="btnseparator"></div><div class="pGroup"><span class="pPageStat"></span></div></div>');var e=a.om.lang._get(f,"omGrid","pageText").replace(/{totalPage}/,"<span>1</span>").replace(/{index}/,'<input type="text" size="4" value="1" />');a(".pControl",b).html(e);d.parent().after(b);a(".pReload",b).click(function(){c._populate()});a(".pFirst",b).click(function(){c._changePage("first")});a(".pPrev",b).click(function(){c._changePage("prev")});a(".pNext",b).click(function(){c._changePage("next")});a(".pLast",b).click(function(){c._changePage("last")});a(".pControl input",b).keydown(function(g){if(g.keyCode==a.om.keyCode.ENTER){c._changePage("input")}});a(".pButton",b).hover(function(){a(this).addClass("om-state-hover")},function(){a(this).removeClass("om-state-hover")});this.pager=b},_buildLoadMask:function(){var b=this.element.closest(".om-grid");this.loadMask.css({width:"100%",height:b.height()})},_changePage:function(c){if(this.loading){return true}var e=this.element,h=this.options,b=e.closest(".om-grid"),d=this.pageData,g=d.nowPage,i=d.totalPages,f=g;this._oldPage=g;switch(c){case"first":f=1;break;case"prev":if(g>1){f=g-1}break;case"next":if(g<i){f=g+1}break;case"last":f=i;break;case"input":var j=parseInt(a(".pControl input",e.closest(".om-grid")).val());if(isNaN(j)){j=g}if(j<1){j=1}else{if(j>i){j=i}}a(".pControl input",this.pDiv).val(j);f=j;break;default:if(/\d/.test(c)){var j=parseInt(c);if(isNaN(j)){j=1}if(j<1){j=1}else{if(j>i){j=i}}a(".pControl input",e.closest(".om-grid")).val(j);f=j}}if(f==g){return false}if(this._trigger("onPageChange",null,c,f)===false){return}d.nowPage=f;this._populate()},_populate:function(){var k=this,f=this.element,b=f.closest(".om-grid"),j=this.options,e=a(".pPageStat",b);if(!j.dataSource){a(".pPageStat",b).html(j.emptygMsg);return false}if(this.loading){return true}var d=this.pageData,h=d.nowPage||1,c=a(".gBlock",b);this.loading=true;e.html(a.om.lang._get(j,"omGrid","loadingMsg"));c.show();var i=(j.limit<=0)?100000000:j.limit;var g=a.extend(true,{},this._extraData,j.extraData,{start:i*(h-1),limit:i,_time_stamp_:new Date().getTime()});a.ajax({type:j.method,url:j.dataSource,data:g,dataType:"json",success:function(o,q,n){var p=j.onSuccess;if(typeof(p)=="function"){k._trigger("onSuccess",null,o,q,n)}k._addData(o);for(var m=0,l=j._onRefreshCallbacks.length;m<l;m++){j._onRefreshCallbacks[m].call(k)}k._trigger("onRefresh",null,h,o.rows);c.hide();k.loading=false},error:function(m,p,o){e.html(a.om.lang._get(j,"omGrid","errorMsg")).css("color","red");try{var l=j.onError;if(typeof(l)=="function"){l(m,p,o)}}catch(n){}finally{c.hide();k.loading=false;k.pageData.data={rows:[],total:0};return false}}})},_addData:function(g){var h=this.options,f=this.element,e=f.closest(".om-grid"),b=a(".pPageStat",e),d=h.preProcess,c=this.pageData;d&&(g=d(g));c.data=g;c.totalPages=Math.ceil(g.total/h.limit);this._buildPager();this._renderDatas()},_buildPager:function(){var i=this.options;if(i.limit<=0){return}var e=this.element,g=this.pager,b=a(".pControl",g),d=this.pageData,f=d.nowPage,j=d.totalPages,h=d.data,l=i.limit*(f-1)+1,k=l-1+h.rows.length,c="";if(h.total===0){c=a.om.lang._get(i,"omGrid","emptyMsg")}else{c=a.om.lang._get(i,"omGrid","pageStat").replace(/{from}/,l).replace(/{to}/,k).replace(/{total}/,h.total)}a("input",b).val(f);a("span",b).html(j);a(".pPageStat",g).html(c)},_renderDatas:function(){var r=this,f=this.element,l=this.options,c=f.closest(".om-grid"),n=this._getHeaderCols(),s=this.pageData.data.rows||[],o=this._getColModel(),h=l.rowClasses,k=a("tbody",f).empty(),b=(typeof h==="function"),e=this.pageData,d=(e.nowPage-1)*l.limit,g="<td align='$' abbr='$' class='$'><div align='$' class='innerCol $' style='width:$px'>$</div></td>",q=[],p=[],m,i;if(!this.pageData.data.rows){this.pageData.data.rows=[]}r.hDiv.scrollLeft(0);a(n).each(function(j){q[j]=a("div",a(this)).width()});a.each(s,function(j,u){var t=b?h(j,u):h[j%h.length];var v=r._buildRowCellValues(o,u,j);p.push("<tr _grid_row_id="+(r._guid++)+" class='om-grid-row "+t+"'>");a(n).each(function(x){var A=a(this).attr("axis"),z=false,y;if(A=="indexCol"){y=j+d+1}else{if(A=="checkboxCol"){y='<span class="checkbox"/>'}else{if(A.substring(0,3)=="col"){var w=A.substring(3);y=v[w];if(o[w].wrap){z=true}}else{y=""}}}m=[this.align,this.abbr,A,this.align,z?"wrap":"",q[x],y];i=0;p.push(g.replace(/\$/g,function(){return m[i++]}))});p.push("</tr>")});k.html(p.join(" "))},_getHeaderCols:function(){return this.hDiv.find("th[axis]")},_buildRowCellValues:function(n,e,m){var h=n.length,o=[];for(var g=0;g<h;g++){var l=n[g],p,b=l.renderer;if(l.name.indexOf(".")>0){var k=l.name.split("."),f=1,d=k.length,p=e[k[0]];while(f<d&&p&&(p=p[k[f++]])!=undefined){}}if(p==undefined){p=e[l.name]==undefined?"":e[l.name]}if(typeof b==="function"){p=b(p,e,m)}o[g]=p;p=null}return o},_bindScrollEnvent:function(){var b=this;this.tbody.closest(".bDiv").scroll(function(){b.hDiv.scrollLeft(a(this).scrollLeft())})},_bindSelectAndClickEnvent:function(){var b=this;this.tbody.unbind();if(!this.options.singleSelect){a("th.checkboxCol span.checkbox",this.thead).click(function(){var e=a(this),d=b._getTrs().size();if(e.hasClass("selected")){e.removeClass("selected");for(var c=0;c<d;c++){b._rowDeSelect(c)}}else{e.addClass("selected");for(var c=0;c<d;c++){b._rowSelect(c)}}});this.tbody.delegate("tr.om-grid-row","click",function(d){var e=a(this),c=b._getRowIndex(e);if(e.hasClass("om-state-highlight")){b._rowDeSelect(c)}else{b._rowSelect(c)}b._refreshHeaderCheckBox();b._trigger("onRowClick",d,c,b._getRowData(c))});this.tbody.delegate("tr.om-grid-row","dblclick",function(d){var e=a(this),c=b._getRowIndex(e);if(e.hasClass("om-state-highlight")){}else{b._rowSelect(c);b._refreshHeaderCheckBox()}b._trigger("onRowDblClick",d,c,b._getRowData(c))})}else{this.tbody.delegate("tr.om-grid-row","click",function(d){var f=a(this),c=b._getRowIndex(f);if(f.hasClass("om-state-highlight")){}else{var e=b._getRowIndex(b.tbody.find("tr.om-state-highlight:not(:hidden)"));(e!=-1)&&b._rowDeSelect(e);b._rowSelect(c)}b._trigger("onRowClick",d,c,b._getRowData(c))});this.tbody.delegate("tr.om-grid-row","dblclick",function(d){var c=b._getRowIndex(this);b._trigger("onRowDblClick",d,c,b._getRowData(c))})}},_getRowData:function(b){return this.pageData.data.rows[b]},_rowSelect:function(d){var e=this.element,g=this.options,c=a("tbody",e),f=this._getTrs().eq(d),b=a("td.checkboxCol span.checkbox",f);f.addClass("om-state-highlight");b.addClass("selected");this._trigger("onRowSelect",null,d,this._getRowData(d))},_rowDeSelect:function(d){var e=this.element,g=this.options,c=a("tbody",e),f=this._getTrs().eq(d),b=a("td.checkboxCol span.checkbox",f);f.removeClass("om-state-highlight");b.removeClass("selected");this._trigger("onRowDeselect",null,d,this._getRowData(d))},_refreshHeaderCheckBox:function(){var e=this.getSelections(),d=this._getTrs(),c=a("th.checkboxCol span.checkbox",this.thead),b=d.length;c.toggleClass("selected",b>0&&b==e.length)},_makeColsResizable:function(){var b=this,e=b.tbody.closest(".bDiv"),d=b.element.closest(".om-grid"),c=this.titleDiv,f;a('th[axis^="col"] div',b.thead).omResizable({handles:"e",containment:"document",minWidth:60,resize:function(k,j){var l=a(this),h=l.parent().attr("abbr"),i=a('td[abbr="'+h+'"] > div',b.tbody),g=b.thead.closest(".hDiv");l.width(k.size.width).height("");i.width(k.size.width).height("");e.height(d.height()-(c.is(":hidden")?0:c.outerHeight(true))-g.outerHeight(true)-(b.pDiv.is(":hidden")?0:b.pDiv.outerHeight(true)));g.scrollLeft(e.scrollLeft())},start:function(h,g){f=a(this).parent().width()},stop:function(n,m){var l=b.options._onResizableCallbacks,k=a(this).parent(),h=b.thead.closest(".hDiv");f=k.width()-f;for(var j=0,g=l.length;j<g;j++){l[j].call(b,k,f)}h.scrollLeft(e.scrollLeft())}})},_getRowIndex:function(b){return this._getTrs().index(b)},_getTrs:function(){return this.tbody.find("tr.om-grid-row:not([_delete]=true)")},setData:function(b){this.options.dataSource=b;this.pageData={nowPage:1,totalPages:1};this._populate()},getData:function(){return this.pageData.data},refresh:function(){if(this.loading){return true}this.loading=true;var d=this.options;a(".pPageStat",this.pager).html(a.om.lang._get(d,"omGrid","loadingMsg"));this.loadMask.show();this._buildPager();this._renderDatas();this._trigger("onRefresh",null,this.pageData.nowPage||1,this.pageData.data.rows);for(var c=0,b=d._onRefreshCallbacks.length;c<b;c++){d._onRefreshCallbacks[c].call(this)}this.loadMask.hide();this.loading=false},reload:function(b){if(this.loading){return true}if(typeof b!=="undefined"){b=parseInt(b)||1;if(b<0){b=1}if(b>this.pageData.totalPages){b=this.pageData.totalPages}this.pageData.nowPage=b}this._populate()},setSelections:function(c){var b=this;if(!a.isArray(c)){c=[c]}var d=this.getSelections();a(d).each(function(){b._rowDeSelect(this)});a(c).each(function(){b._rowSelect(this)});b._refreshHeaderCheckBox()},getSelections:function(c){var f=this,e=f._getTrs(),g=e.filter(".om-state-highlight"),b=[];if(c){var d=f.getData().rows;g.each(function(h,i){b[b.length]=d[e.index(i)]})}else{g.each(function(h,i){b[b.length]=e.index(i)})}return b},destroy:function(){var b=this.element;b.closest(".om-grid").after(b).remove()}});a.om.lang.omGrid={loadingMsg:"正在加载数据，请稍候...",emptyMsg:"没有数据",errorMsg:"取数出错",pageText:"第{index}页，共{totalPage}页",pageStat:"共{total}条数据，显示{from}-{to}条"}})(jQuery);